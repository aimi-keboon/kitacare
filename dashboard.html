<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Portal | kitacare</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background-color: var(--bg-light); }
        .dashboard-wrapper { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 80px); }
        
        /* Sidebar Navigation */
        .sidebar { background: var(--brand-black); color: white; padding: 40px 0; }
        .nav-item { 
            padding: 18px 30px; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 0.8rem; 
            letter-spacing: 1.5px; 
            text-transform: uppercase;
            transition: 0.3s;
            border-left: 4px solid transparent;
        }
        .nav-item:hover { background: #1A1A1A; color: var(--brand-blue); }
        .nav-item.active { background: #1A1A1A; border-left: 4px solid var(--brand-blue); color: var(--brand-blue); }

        .main-content { padding: 50px; }
        .section-header { margin-bottom: 40px; border-bottom: 2px solid var(--brand-black); padding-bottom: 15px; }
        
        /* UI Cards & Tables */
        .card { background: white; border: 1px solid var(--border-gray); padding: 35px; border-radius: 4px; margin-bottom: 20px; }
        .multi-date-container { background: #f0f0f0; padding: 20px; border-radius: 4px; margin-bottom: 20px; border: 1px dashed var(--brand-black); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--brand-black); color: white; text-align: left; padding: 15px; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border-gray); background: white; font-size: 0.9rem; }
        
        .status-pill { padding: 4px 12px; border-radius: 2px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .status-paid { background: #28a745; color: white; }
        .status-pending { background: var(--brand-blue); color: white; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .btn-outline { border: 2px solid var(--brand-black); background: transparent; padding: 8px 15px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <a href="dashboard.html" class="logo-link"><img src="kitacare.png" alt="kitacare"></a>
        <nav><a href="#" onclick="logout()" style="color:red; border: 1px solid red; padding: 8px 15px; border-radius: 4px; text-decoration:none; font-weight:bold; font-size: 0.8rem;">Logout</a></nav>
    </header>

    <div class="dashboard-wrapper">
        <div class="sidebar">
            <div class="nav-item active" id="nav-book" onclick="showSection('book')">Book a Caretaker</div>
            <div class="nav-item" id="nav-details" onclick="showSection('details')">Booking Details</div>
            <div class="nav-item" id="nav-profile" onclick="showSection('profile')">My Profile</div>
        </div>

        <div class="main-content">
            
            <section id="section-book">
                <div class="section-header"><h1>Book a Caretaker</h1></div>
                <div class="card">
                    <h3 style="text-transform: uppercase; font-size: 0.8rem; margin-bottom: 20px; color: var(--brand-blue);">1. Care Recipient Information</h3>
                    <div class="grid-2">
                        <div class="input-group"><label>Full Name</label><input type="text" id="r-name"></div>
                        <div class="input-group"><label>Date of Birth</label><input type="date" id="r-dob"></div>
                    </div>
                    <div class="grid-2">
                        <div class="input-group"><label>Age</label><input type="number" id="r-age"></div>
                        <div class="input-group"><label>Gender</label><select id="r-gender"><option>Male</option><option>Female</option></select></div>
                    </div>
                    <div class="grid-2">
                        <div class="input-group"><label>Emergency Contact Name</label><input type="text" id="r-e-name"></div>
                        <div class="input-group"><label>Emergency Contact Number</label><input type="tel" id="r-e-phone"></div>
                    </div>

                    <h3 style="text-transform: uppercase; font-size: 0.8rem; margin-top: 30px; margin-bottom: 20px; color: var(--brand-blue);">2. Care Details</h3>
                    <div class="input-group"><label>Purpose of Visit</label><textarea id="c-purpose" style="height:80px;"></textarea></div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label>Looking for Role</label>
                            <select id="c-role"><option>Caregiver</option><option>Nurse</option><option>Doctor</option></select>
                        </div>
                        <div class="input-group"><label>Medications/Diagnosis</label><input type="text" id="c-meds"></div>
                    </div>

                    <div class="input-group" style="margin: 20px 0;">
                        <input type="checkbox" id="multi-toggle" style="width:auto; margin-right:10px;" onclick="toggleMultiDate()"> 
                        <label style="display:inline;">Multi-dates arrangement needed?</label>
                    </div>

                    <div id="date-selection-area">
                        <div class="input-group">
                            <label>Preferred Date & Time</label>
                            <input type="datetime-local" class="date-input-field">
                            <p style="font-size: 0.7rem; color: #777; margin-top: 5px;">* Minimum 5 days notice required.</p>
                        </div>
                    </div>

                    <button class="btn-primary" id="book-btn" style="width:100%; margin-top:30px;" onclick="proceedToPayment()">PROCEED TO DEPOSIT PAYMENT</button>
                </div>
            </section>

            <section id="section-details" class="hidden">
                <div class="section-header"><h1>Booking Details</h1></div>
                <div class="card" style="padding: 0; overflow: hidden;">
                    <table>
                        <thead>
                            <tr>
                                <th>Ref No.</th>
                                <th>Recipient</th>
                                <th>Role</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="history-table">
                            <tr><td colspan="4" style="text-align:center; padding: 40px;">Fetching records...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-profile" class="hidden">
                <div class="section-header"><h1>My Profile</h1></div>
                <div class="card">
                    <div class="grid-2">
                        <div class="input-group"><label>Account Role</label><input type="text" id="p-role" disabled></div>
                        <div class="input-group"><label>Full Name</label><input type="text" id="p-name" disabled></div>
                    </div>
                    <div class="grid-2">
                        <div class="input-group"><label>Email Address</label><input type="email" id="p-email" disabled></div>
                        <div class="input-group"><label>Contact Number</label><input type="tel" id="p-phone" disabled></div>
                    </div>
                    <div class="grid-2">
                        <div class="input-group"><label>Date of Birth</label><input type="text" id="p-dob" disabled></div>
                        <div class="input-group"><label>Gender</label><input type="text" id="p-gender" disabled></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // --- INITIALIZATION & SECURITY ---
        window.onload = function() {
            const rawData = localStorage.getItem("userData");
            if (!rawData) { window.location.href = "auth.html"; return; }

            const user = JSON.parse(rawData);
            
            // Redirect non-clients
            if (user.role !== "Client") {
                window.location.href = "professionals.html";
                return;
            }

            // Populate Profile Fields
            document.getElementById('p-role').value = user.role;
            document.getElementById('p-name').value = user.name;
            document.getElementById('p-email').value = user.email;
            document.getElementById('p-phone').value = user.phone;
            document.getElementById('p-gender').value = user.gender;
            if(user.dob) document.getElementById('p-dob').value = new Date(user.dob).toLocaleDateString();

            applyDateRestrictions();
            fetchHistory();
        };

        function logout() { localStorage.clear(); window.location.href = "index.html"; }

        function showSection(name) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('section-' + name).classList.remove('hidden');
            document.getElementById('nav-' + name).classList.add('active');
            if(name === 'details') fetchHistory();
        }

        function applyDateRestrictions() {
            const minDate = new Date();
            minDate.setDate(minDate.getDate() + 5);
            const minStr = minDate.toISOString().slice(0, 16);
            document.querySelectorAll('.date-input-field').forEach(i => i.min = minStr);
        }

        function toggleMultiDate() {
            const area = document.getElementById('date-selection-area');
            if (document.getElementById('multi-toggle').checked) {
                area.innerHTML = `<div class="multi-date-container" id="multi-list">
                    <div class="input-group"><label>Date #1</label><input type="datetime-local" class="date-input-field"></div>
                </div><button class="btn-outline" onclick="addSlot()">+ Add Date</button>`;
            } else {
                area.innerHTML = `<div class="input-group"><label>Preferred Date</label><input type="datetime-local" class="date-input-field"></div>`;
            }
            applyDateRestrictions();
        }

        function addSlot() {
            const list = document.getElementById('multi-list');
            const div = document.createElement('div');
            div.className = "input-group";
            div.innerHTML = `<label>Date #${list.children.length + 1}</label><input type="datetime-local" class="date-input-field">`;
            list.appendChild(div);
            applyDateRestrictions();
        }

        // --- BOOKING LOGIC (NO-CORS FIX) ---
        async function proceedToPayment() {
            const btn = document.getElementById('book-btn');
            const dates = Array.from(document.querySelectorAll('.date-input-field')).map(i => i.value).filter(v => v);
            
            if(!dates.length) return alert("Select at least one date.");
            
            const data = {
                action: "book",
                userEmail: localStorage.getItem("userEmail"),
                recipientName: document.getElementById('r-name').value,
                recipientDob: document.getElementById('r-dob').value,
                age: document.getElementById('r-age').value,
                gender: document.getElementById('r-gender').value,
                emergencyName: document.getElementById('r-e-name').value,
                emergencyPhone: document.getElementById('r-e-phone').value,
                purpose: document.getElementById('c-purpose').value,
                requestedRole: document.getElementById('c-role').value,
                meds: document.getElementById('c-meds').value,
                dates: dates.join(" | ")
            };

            btn.innerText = "REDIRECTING TO PAYMENT...";
            btn.disabled = true;

            // Optimistic Redirect Timer (2.5 seconds)
            const forceRedirect = setTimeout(() => {
                window.location.href = "https://buy.stripe.com/test_6oUcN6a7P9sZ415fJjgw000";
            }, 2500);

            try {
                // Send data to Google Sheet without waiting for a formal response
                await fetch(APPS_SCRIPT_URL, { 
                    method: "POST", 
                    mode: "no-cors", 
                    body: JSON.stringify(data)
                });
                
                clearTimeout(forceRedirect);
                window.location.href = "https://buy.stripe.com/test_6oUcN6a7P9sZ415fJjgw000";
            } catch(e) {
                window.location.href = "https://buy.stripe.com/test_6oUcN6a7P9sZ415fJjgw000";
            }
        }

        async function fetchHistory() {
            const email = localStorage.getItem("userEmail");
            const table = document.getElementById('history-table');
            try {
                const res = await fetch(APPS_SCRIPT_URL + "?email=" + encodeURIComponent(email));
                const data = await res.json();
                table.innerHTML = data.map(row => `
                    <tr>
                        <td><b>${row.ref}</b></td>
                        <td>${row.recipient}</td>
                        <td>${row.role}</td>
                        <td><span class="status-pill ${row.status === 'Paid' ? 'status-paid' : 'status-pending'}">${row.status}</span></td>
                    </tr>
                `).join('') || "<tr><td colspan='4' style='text-align:center'>No bookings found.</td></tr>";
            } catch(e) { console.log("Fetch failed"); }
        }
    </script>
</body>
</html>