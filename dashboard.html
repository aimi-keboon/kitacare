<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Portal | kitacare</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background-color: var(--bg-light); }
        .dashboard-wrapper { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 80px); }
        
        /* Sidebar */
        .sidebar { background: var(--brand-black); color: white; padding: 40px 0; }
        .nav-item { padding: 18px 30px; cursor: pointer; font-weight: 700; font-size: 0.8rem; letter-spacing: 1.5px; text-transform: uppercase; transition: 0.3s; border-left: 4px solid transparent; }
        .nav-item:hover { background: #1A1A1A; color: var(--brand-blue); }
        .nav-item.active { background: #1A1A1A; border-left: 4px solid var(--brand-blue); color: var(--brand-blue); }

        .main-content { padding: 50px; }
        .section-header { margin-bottom: 40px; border-bottom: 2px solid var(--brand-black); padding-bottom: 15px; }
        .card { background: white; border: 1px solid var(--border-gray); padding: 35px; border-radius: 4px; margin-bottom: 20px; }
        
        /* Table & Dropdown Styles */
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--brand-black); color: white; text-align: left; padding: 15px; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border-gray); font-size: 0.9rem; }
        
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background: #f9f9f9; }
        .clickable-row td:last-child::after { content: ' â–¼'; font-size: 0.6rem; color: #999; }
        
        .detail-row { background: #fdfdfd; display: none; }
        .detail-row.open { display: table-row; }
        .detail-container { padding: 20px; border: 2px solid var(--brand-blue); border-top: none; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 0.85rem; }
        .detail-item b { display: block; text-transform: uppercase; font-size: 0.7rem; color: var(--brand-blue); margin-bottom: 5px; }

        .status-pill { padding: 4px 12px; border-radius: 2px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .status-paid { background: #28a745; color: white; }
        .status-pending { background: var(--brand-blue); color: white; }
        
        .hidden { display: none; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <header>
        <a href="dashboard.html" class="logo-link"><img src="kitacare.png" alt="kitacare"></a>
        <nav><a href="#" onclick="logout()" style="color:red; border: 1px solid red; padding: 8px 15px; border-radius: 4px; text-decoration:none; font-weight:bold; font-size:0.8rem;">Logout</a></nav>
    </header>

    <div class="dashboard-wrapper">
        <div class="sidebar">
            <div class="nav-item active" id="nav-book" onclick="showSection('book')">Book a Caretaker</div>
            <div class="nav-item" id="nav-details" onclick="showSection('details')">Booking Details</div>
            <div class="nav-item" id="nav-profile" onclick="showSection('profile')">My Profile</div>
        </div>

        <div class="main-content">
            
            <section id="section-book">
                <div class="section-header"><h1>Book a Caretaker</h1></div>
                <div class="card">
                    <h3 style="text-transform: uppercase; font-size: 0.8rem; margin-bottom: 20px; color: var(--brand-blue);">1. Care Recipient Information</h3>
                    <div class="grid-2">
                        <div class="input-group"><label>Full Name</label><input type="text" id="r-name"></div>
                        <div class="input-group"><label>Date of Birth</label><input type="date" id="r-dob"></div>
                    </div>
                    <div class="grid-2">
                        <div class="input-group"><label>Age</label><input type="number" id="r-age"></div>
                        <div class="input-group"><label>Gender</label><select id="r-gender"><option>Male</option><option>Female</option></select></div>
                    </div>
                    <div class="grid-2">
                        <div class="input-group"><label>Emergency Contact Name</label><input type="text" id="r-e-name"></div>
                        <div class="input-group"><label>Emergency Contact Number</label><input type="tel" id="r-e-phone"></div>
                    </div>

                    <h3 style="text-transform: uppercase; font-size: 0.8rem; margin-top: 30px; margin-bottom: 20px; color: var(--brand-blue);">2. Service Details</h3>
                    <div class="input-group"><label>Reason for Visit</label><textarea id="c-purpose" style="height:80px;"></textarea></div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label>Requested Role</label>
                            <select id="c-role"><option>Caregiver</option><option>Nurse</option><option>Doctor</option></select>
                        </div>
                        <div class="input-group"><label>Medical History/Meds</label><input type="text" id="c-meds"></div>
                    </div>

                    <div class="input-group" style="margin: 20px 0;">
                        <input type="checkbox" id="multi-toggle" style="width:auto; margin-right:10px;" onclick="toggleMultiDate()"> 
                        <label style="display:inline;">Add multiple dates?</label>
                    </div>

                    <div id="date-selection-area">
                        <div class="input-group">
                            <label>Preferred Date & Time</label>
                            <input type="datetime-local" class="date-input-field">
                        </div>
                    </div>

                    <button class="btn-primary" id="book-btn" style="width:100%; margin-top:30px;" onclick="proceedToPayment()">PROCEED TO DEPOSIT PAYMENT</button>
                </div>
            </section>

            <section id="section-details" class="hidden">
                <div class="section-header"><h1>Booking Details</h1></div>
                <div class="card" style="padding: 0; overflow: hidden;">
                    <table id="bookings-table">
                        <thead>
                            <tr>
                                <th>Ref No.</th>
                                <th>Recipient</th>
                                <th>Service</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="history-table">
                            <tr><td colspan="4" style="text-align:center; padding: 40px;">Loading bookings...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-profile" class="hidden">
                <div class="section-header"><h1>My Profile</h1></div>
                <div class="card">
                    <div class="grid-2">
                        <div class="input-group"><label>Full Name</label><input type="text" id="p-name" disabled></div>
                        <div class="input-group"><label>Email</label><input type="text" id="p-email" disabled></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        window.onload = function() {
            const user = JSON.parse(localStorage.getItem("userData"));
            if (!user) { window.location.href = "auth.html"; return; }
            document.getElementById('p-name').value = user.name;
            document.getElementById('p-email').value = user.email;
            fetchHistory();
        };

        function logout() { localStorage.clear(); window.location.href = "index.html"; }

        function showSection(name) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('section-' + name).classList.remove('hidden');
            document.getElementById('nav-' + name).classList.add('active');
        }

        function toggleMultiDate() {
            const area = document.getElementById('date-selection-area');
            if (document.getElementById('multi-toggle').checked) {
                area.innerHTML = `<div id="multi-list"><div class="input-group"><input type="datetime-local" class="date-input-field"></div></div>
                                  <button class="btn-outline" onclick="addSlot()">+ Add Another Date</button>`;
            } else {
                area.innerHTML = `<div class="input-group"><input type="datetime-local" class="date-input-field"></div>`;
            }
        }

        function addSlot() {
            const div = document.createElement('div');
            div.className = "input-group";
            div.innerHTML = `<input type="datetime-local" class="date-input-field">`;
            document.getElementById('multi-list').appendChild(div);
        }

        async function proceedToPayment() {
            const btn = document.getElementById('book-btn');
            const dates = Array.from(document.querySelectorAll('.date-input-field')).map(i => i.value).filter(v => v);
            if(!dates.length) return alert("Please select a date.");

            const data = {
                action: "book",
                userEmail: localStorage.getItem("userEmail"),
                recipientName: document.getElementById('r-name').value,
                recipientDob: document.getElementById('r-dob').value,
                age: document.getElementById('r-age').value,
                gender: document.getElementById('r-gender').value,
                emergencyName: document.getElementById('r-e-name').value,
                emergencyPhone: document.getElementById('r-e-phone').value,
                purpose: document.getElementById('c-purpose').value,
                requestedRole: document.getElementById('c-role').value,
                meds: document.getElementById('c-meds').value,
                dates: dates.join(" | ")
            };

            btn.innerText = "SAVING...";
            btn.disabled = true;

            try {
                const res = await fetch(APPS_SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });
                const result = await res.json();
                if(result.status === "success") window.location.href = "https://buy.stripe.com/8x2eVe4Nv7kR9lp8gRgw00d";
            } catch(e) { alert("Error saving. Try again."); btn.disabled = false; btn.innerText = "PROCEED"; }
        }

        async function fetchHistory() {
            const email = localStorage.getItem("userEmail");
            const table = document.getElementById('history-table');
            try {
                const res = await fetch(APPS_SCRIPT_URL + "?email=" + encodeURIComponent(email));
                const data = await res.json();
                
                if (data.length === 0) {
                    table.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px;'>No bookings found.</td></tr>";
                    return;
                }

                table.innerHTML = data.map((row, index) => `
                    <tr class="clickable-row" onclick="toggleDetails(${index})">
                        <td><b>${row.ref}</b></td>
                        <td>${row.recipient}</td>
                        <td>${row.role}</td>
                        <td><span class="status-pill ${row.status === 'Paid' ? 'status-paid' : 'status-pending'}">${row.status}</span></td>
                    </tr>
                    <tr class="detail-row" id="details-${index}">
                        <td colspan="4">
                            <div class="detail-container">
                                <div class="detail-item"><b>Reason/Diagnosis</b>${row.purpose || 'N/A'}</div>
                                <div class="detail-item"><b>Medical History/Meds</b>${row.meds || 'None'}</div>
                                <div class="detail-item"><b>Emergency Contact</b>${row.eName || 'N/A'} (${row.ePhone || 'N/A'})</div>
                                <div class="detail-item"><b>Booked Dates</b>${row.dates}</div>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch(e) { table.innerHTML = "<tr><td colspan='4'>Failed to load bookings.</td></tr>"; }
        }

        function toggleDetails(index) {
            const row = document.getElementById(`details-${index}`);
            row.classList.toggle('open');
        }
    </script>
</body>
</html>